



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Kafka Streams Implementation - Reefer Container Management Service</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#kafka-streams-implementation-of-the-container-inventory-management" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Reefer Container Management Service" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Reefer Container Management Service
            </span>
            <span class="md-header-nav__topic">
              Kafka Streams Implementation
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Reefer Container Management Service" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Reefer Container Management Service
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ES2DDD2MS/" title="Analysis and design considerations" class="md-nav__link">
      Analysis and design considerations
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Different implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Different implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Kafka Streams Implementation
      </label>
    
    <a href="./" title="Kafka Streams Implementation" class="md-nav__link md-nav__link--active">
      Kafka Streams Implementation
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start-with-maven" title="Start with maven" class="md-nav__link">
    Start with maven
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-with-ibm-cloud-microprofile-starter-kit" title="Start with IBM Cloud microprofile starter kit" class="md-nav__link">
    Start with IBM Cloud microprofile starter kit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-useful-kafka-streams-apis" title="Some useful Kafka streams APIs" class="md-nav__link">
    Some useful Kafka streams APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-driven-development" title="Test Driven Development" class="md-nav__link">
    Test Driven Development
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#container-inventory" title="Container inventory" class="md-nav__link">
    Container inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#container-to-order-assignment" title="Container to Order Assignment" class="md-nav__link">
    Container to Order Assignment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-tests" title="Run tests" class="md-nav__link">
    Run tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-compose-configuration" title="docker compose configuration" class="md-nav__link">
    docker compose configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-streams-flows-are-resilient" title="How streams flows are resilient?" class="md-nav__link">
    How streams flows are resilient?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-scale" title="How to scale?" class="md-nav__link">
    How to scale?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../springboot/" title="Springboot - Kafka and PostgreSQL Implementation" class="md-nav__link">
      Springboot - Kafka and PostgreSQL Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../flask/" title="Python Flask and Kafka Implementation" class="md-nav__link">
      Python Flask and Kafka Implementation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment/" title="Pre-requisites" class="md-nav__link">
      Pre-requisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../springboot/" title="Run spring boot app locally" class="md-nav__link">
      Run spring boot app locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cicd/" title="Continuous delivery" class="md-nav__link">
      Continuous delivery
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../springboot/#security" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../springboot/#the-integration-tests" title="Run integration tests" class="md-nav__link">
      Run integration tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../metrics/" title="Container Predictive Maintenance" class="md-nav__link">
      Container Predictive Maintenance
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start-with-maven" title="Start with maven" class="md-nav__link">
    Start with maven
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-with-ibm-cloud-microprofile-starter-kit" title="Start with IBM Cloud microprofile starter kit" class="md-nav__link">
    Start with IBM Cloud microprofile starter kit
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-useful-kafka-streams-apis" title="Some useful Kafka streams APIs" class="md-nav__link">
    Some useful Kafka streams APIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-driven-development" title="Test Driven Development" class="md-nav__link">
    Test Driven Development
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#container-inventory" title="Container inventory" class="md-nav__link">
    Container inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#container-to-order-assignment" title="Container to Order Assignment" class="md-nav__link">
    Container to Order Assignment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#run-tests" title="Run tests" class="md-nav__link">
    Run tests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-compose-configuration" title="docker compose configuration" class="md-nav__link">
    docker compose configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-streams-flows-are-resilient" title="How streams flows are resilient?" class="md-nav__link">
    How streams flows are resilient?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-scale" title="How to scale?" class="md-nav__link">
    How to scale?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/edit/master/docs/kstreams/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="kafka-streams-implementation-of-the-container-inventory-management">Kafka Streams implementation of the container inventory management</h1>
<p>In this chapter we are presenting how to sue the Kafka Streams API combined with Kafka event sourcing to implement the container inventory management. </p>
<p>The component can be represented in the figure below:</p>
<p><img alt="" src="../images/kstreams-container.png" /></p>
<p>For getting started with Kafka Streams API read <a href="https://kafka.apache.org/documentation/streams/">this tutorial</a>.</p>
<p>The container topics includes all the event about container life cycle. The application is Java based and deployed in Liberty packaged into a docker image deployable on Kubernetes. The service exposes some RESTful APIs to get a container by ID. No CUD operations as all is done via events. The Streams implementation keeps data in Ktable.</p>
<p>As a java based microservice we have two approaches to implement the service: springboot and microprofile. Knowing we will deploy on kubernetes cluster with Istio we will have a lot of the resiliency and scalability addressed for us. <a href="https://microprofile.io/">Microprofile</a> add a lot of nice capabilities like SSL, open API, JAXRS... Microprofile is supported by Open Liberty as well as many servers.</p>
<p>The <a href="https://kafka.apache.org/documentation/streams/">Apache Kafka Streams API</a> is a client library for building applications and microservices, where the input and output data are stored in Kafka clusters. It simplifies the implementation of the stateless or stateful event processing to transform and enrich data. It supports time windowing processing.</p>
<p>We encourage to do <a href="https://kafka.apache.org/21/documentation/streams/tutorial">this Streams tutorial</a>. </p>
<p>The features we want to illustrate in this implementation, using KStreams are:</p>
<ul>
<li>Listen to ContainerAddedToInventory event from the <code>containers</code> topic and maintains a stateful table of containers. </li>
<li>Listen to OrderCreated event from <code>orders</code> and assign a container from the inventory based on the pickup location and the container location and its characteristics.</li>
<li>Implemented as JAXRS application deployed on Liberty and packaged with dockerfile.</li>
<li>Deploy to kubernetes or run with docker-compose</li>
</ul>
<h2 id="start-with-maven">Start with maven</h2>
<p>Kafka streams delivers a Maven archetype to create a squeleton project. The following command can be used to create the base code.
<div class="codehilite"><pre><span></span>mvn archetype:generate -DarchetypeGroupId<span class="o">=</span>org.apache.kafka -DarchetypeArtifactId<span class="o">=</span>streams-quickstart-java     -DarchetypeVersion<span class="o">=</span><span class="m">2</span>.1.0     -DgroupId<span class="o">=</span>kc-container     -DartifactId<span class="o">=</span>kc-container-streams    -Dversion<span class="o">=</span><span class="m">0</span>.1     -Dpackage<span class="o">=</span>containerManager
</pre></div></p>
<p>We added a <code>.project</code> file to develop the code in Eclipse, imported the code into Eclipse and modify the <code>.classpath</code> with the following lines:
<div class="codehilite"><pre><span></span>    <span class="nt">&lt;classpathentry</span> <span class="na">kind=</span><span class="s">&quot;con&quot;</span> <span class="na">path=</span><span class="s">&quot;org.eclipse.m2e.MAVEN2_CLASSPATH_CONTAINER&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;attributes&gt;</span>
            <span class="nt">&lt;attribute</span> <span class="na">name=</span><span class="s">&quot;maven.pomderived&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/attributes&gt;</span>
    <span class="nt">&lt;/classpathentry&gt;</span>
</pre></div></p>
<p>To access to serializer and testing framework we added the following dependencies in the pom.xml:</p>
<div class="codehilite"><pre><span></span>      <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.kafka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kafka-clients<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kafka.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.kafka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kafka-streams-test-utils<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${kafka.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<p>Using this approach as the service runs in OpenLiberty and integrate JAXRS, microprofile, Open API,... we have to add a lot of depencies into the pom.xml file. Another approach is to use IBM Cloud starter kit.</p>
<h2 id="start-with-ibm-cloud-microprofile-starter-kit">Start with IBM Cloud microprofile starter kit</h2>
<p>Use the <code>Create resource</code> option and select the "Java microservice with microprofile and Java EE" starter kit as shown below:</p>
<p><img alt="" src="mp-starter.png" /></p>
<p>Then enter an application name (e.g. MP-ContainerMS) with a resource group and may be some tags. </p>
<p><img alt="" src="mp-app-details.png" /></p>
<p>The next step is to select a kubernetes cluster instance:</p>
<p><img alt="" src="mp-select-iks.png" /></p>
<p>Configure the toolchain, and verify the application is created in the console:</p>
<p><img alt="" src="mp-app-listed.png" /></p>
<p>The application is accessible from github, a toolchain is ready to process the app and deploy it.</p>
<p><img alt="" src="default-toolchain.png" /></p>
<p>At the time of writting, and most likely in the future too, the steps and the documentations are not aligned. Code is release on a weekly basis and the documentation is often behind. We can download the source code from the github. The address was https://git.ng.bluemix.net/boyerje/MP-ContainerMS. We have to unprotect the master branch so we can push our update. </p>
<p>We also have to modify the deployment configuration to change the target namespace. </p>
<p>The generated code includes helm chart, Dockerfiles, and base JAXRS code. The code generated is very similar to the one created using the <code>ibmcloud dev</code> CLI. But we need to modify this generated project with some specific microprofile content.</p>
<p>Eclipse microprofile is now on version 2.2, so we also use the following code generator from <a href="https://start.microprofile.io/">the Microprofile starter site</a> so we can get updated code with new capability like SSL, openAPI and JWT supports.</p>
<p><img alt="" src="mp-eclipse-starter.png" /></p>
<p>So now we need to integrate both code and then add Kafka streams. Here are some of the main updates we did:
<em> Add in the cli-config.yml the registry address and cluster name
</em> Change pom dependencies for microprofile 2.2, and change the image in Dockerfile to access websphere liberty 19.0.0.3 compatible with 2.2. (FROM websphere-liberty:19.0.0.3-microProfile2)
<em> Use the health class from the microprofile 2.2 generated code, as it uses microprofile annotation. Add also the configuration injection with properties file. Add new package names.
</em> Remove unnecessary files
* Modify the Values.yaml to reflect the target registry and add secret reference:
<div class="codehilite"><pre><span></span>  repository: us.icr.io/ibmcaseeda/mpcontainerms
  tag: latest
  pullPolicy: Always
  pullSecret: browncompute-registry-secret
</pre></div></p>
<p>Some of those steps are pushed to the development kubernetes cluster using the command:</p>
<h2 id="some-useful-kafka-streams-apis">Some useful Kafka streams APIs</h2>
<p>The stream configuration looks similar to the Kafka consumer and producer configuration. </p>
<p><div class="codehilite"><pre><span></span>    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StreamsConfig</span><span class="o">.</span><span class="na">APPLICATION_ID_CONFIG</span><span class="o">,</span> <span class="s">&quot;container-streams&quot;</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="s">&quot;localhost:9092&quot;</span><span class="o">);</span>    
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_KEY_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="n">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StreamsConfig</span><span class="o">.</span><span class="na">DEFAULT_VALUE_SERDE_CLASS_CONFIG</span><span class="o">,</span> <span class="n">Serdes</span><span class="o">.</span><span class="na">String</span><span class="o">().</span><span class="na">getClass</span><span class="o">());</span>
</pre></div>
The StreamsConfig is a specific configuration for Streams app.  </p>
<p>One of the interesting class is the <code>KStream</code> to manage a stream of structured events. Kstreams represents unbounded collection of immutable events.</p>
<p>Two classes are supporting the order and container processing:</p>
<ul>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/kstreams/src/main/java/ibm/labs/kc/streams/containerManager/ContainerInventoryView.java">ContainerInventoryView</a></li>
<li><a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/kstreams/src/main/java/ibm/labs/kc/streams/containerManager/ContainerOrderAssissgnment.java">ContainerOrderAssignment</a></li>
</ul>
<p>We are using the Streams DSL APIs to do the processing. Here is an example of terminal stream to print what is coming to the <code>orders</code> topic:
<div class="codehilite"><pre><span></span>   <span class="kd">final</span> <span class="n">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamsBuilder</span><span class="o">();</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="s">&quot;orders&quot;</span><span class="o">)</span>
        <span class="o">.</span><span class="na">foreach</span><span class="o">((</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">fromJson</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">value</span><span class="o">,</span> <span class="n">OrderEvent</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getPayload</span><span class="o">();</span>
                    <span class="c1">// TODO do something to the order</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;received order &quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
                <span class="o">});</span>

    <span class="kd">final</span> <span class="n">Topology</span> <span class="n">topology</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">KafkaStreams</span> <span class="n">streams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaStreams</span><span class="o">(</span><span class="n">topology</span><span class="o">,</span> <span class="n">props</span><span class="o">);</span>
    <span class="n">streams</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</pre></div></p>
<p>We want now to implement the container inventory. We want to support the following events:</p>
<ul>
<li>ContainerAddedToInventory, ContainerRemovedFromInventory</li>
<li>ContainerAtLocation</li>
<li>ContainerOnMaintenance, ContainerOffMaintenance,</li>
<li>ContainerAssignedToOrder, ContainerReleasedFromOrder</li>
<li>ContainerGoodLoaded, ContainerGoodUnLoaded</li>
<li>ContainerOnShip, ContainerOffShip</li>
<li>ContainerOnTruck, ContainerOffTruck</li>
</ul>
<p>We want the container event to keep a timestamp, a version, a type, and a payload representing the data describing a Reefer container. The Key is the containerID. The java class for the container event is <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/kstreams/src/main/java/ibm/labs/kc/model/events/ContainerEvent.java">here</a>.</p>
<p>Using a TDD approach we will start by the tests to implement the solution.</p>
<p>For more information on the Streams DSL API, <a href="https://kafka.apache.org/21/documentation/streams/developer-guide/dsl-api.html">keep this page close to you</a>. </p>
<h2 id="test-driven-development">Test Driven Development</h2>
<p>We want to document two major test suites. One for building the internal view of the container inventory, the other to support the container to order assignment.</p>
<h3 id="container-inventory">Container inventory</h3>
<blockquote>
<p>When the service receives a ContainerAdded event it needs to add it to the table and be able to retreive it by ID</p>
</blockquote>
<ol>
<li>To support the Get By ID we are adding a Service class with the operation exposed as RESTful resource using JAXRS annotations. We already described this approach in the <a href="https://github.com/ibm-cloud-architecture/refarch-kc-ms">fleetms project</a>.</li>
</ol>
<p>To test a stream application without Kafka backbone there is a test utility available <a href="https://kafka.apache.org/documentation/streams/developer-guide/testing.html#unit-testing-processors">here</a>. The settings are simple: get the properties, define the serialisation of the key and value of the event to get from kafka, define the stream process flow, named topology, send the input and get the output.</p>
<p>The <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/kstreams/src/test/java/ut">test TestContainerInventory</a> is illustrating how to use the <a href="https://kafka.apache.org/21/javadoc/org/apache/kafka/streams/TopologyTestDriver.html">TopologyTestDriver</a>.</p>
<div class="codehilite"><pre><span></span>    <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="o">.</span><span class="na">getStreamsProperties</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">StreamsConfig</span><span class="o">.</span><span class="na">BOOTSTRAP_SERVERS_CONFIG</span><span class="o">,</span> <span class="s">&quot;dummy:1234&quot;</span><span class="o">);</span>
    <span class="n">TopologyTestDriver</span> <span class="n">testDriver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TopologyTestDriver</span><span class="o">(</span>
                <span class="n">buildProcessFlow</span><span class="o">(),</span> <span class="n">props</span><span class="o">);</span>

    <span class="n">ConsumerRecordFactory</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerRecordFactory</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;(</span><span class="s">&quot;containers&quot;</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">StringSerializer</span><span class="o">(),</span> <span class="k">new</span> <span class="n">StringSerializer</span><span class="o">());</span>
    <span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[],</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">record</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;containers&quot;</span><span class="o">,</span><span class="n">ce</span><span class="o">.</span><span class="na">getContainerID</span><span class="o">(),</span> <span class="n">parser</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">ce</span><span class="o">));</span>

    <span class="n">testDriver</span><span class="o">.</span><span class="na">pipeInput</span><span class="o">(</span><span class="n">record</span><span class="o">);</span>
</pre></div>

<p>We are using the String default serialization for the key and the ContainerEvent, and use Gson to serialize and deserialize the json.</p>
<p>So the test is to prepare a ContainerEvent with type = "ContainerAdded" and then get the payload, persist it in the table and access to the table via the concept of <code>store</code> and validate the data.</p>
<p>Below is the access to the store and compare the expected results</p>
<div class="codehilite"><pre><span></span>    <span class="n">KeyValueStore</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">store</span> <span class="o">=</span> <span class="n">testDriver</span><span class="o">.</span><span class="na">getKeyValueStore</span><span class="o">(</span><span class="s">&quot;queryable-container-store&quot;</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">containerStrg</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ce</span><span class="o">.</span><span class="na">getContainerID</span><span class="o">());</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">containerStrg</span><span class="o">);</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">containerStrg</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">ce</span><span class="o">.</span><span class="na">getContainerID</span><span class="o">()));</span>
    <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">containerStrg</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;atDock&quot;</span><span class="o">));</span>
</pre></div>

<p>Now the tricky part is in the Stream process flow. The idea is to process the ContainerEvent as streams (of String) and extract the payload (a Container), then generate the Container in a new stream, group by the key and then save to a table. We separate the code in a function so e can move it into the real application after.</p>
<div class="codehilite"><pre><span></span>    <span class="kd">public</span>  <span class="n">Topology</span> <span class="nf">buildProcessFlow</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">StreamsBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamsBuilder</span><span class="o">();</span>
       <span class="c1">// containerEvent is a string, map values help to change the type and data of the inpit values</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">CONTAINERS_TOPIC</span><span class="o">).</span><span class="na">mapValues</span><span class="o">((</span><span class="n">containerEvent</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                 <span class="c1">// the container payload is of interest to keep in table</span>
                 <span class="n">Container</span> <span class="n">c</span> <span class="o">=</span> <span class="n">jsonParser</span><span class="o">.</span><span class="na">fromJson</span><span class="o">((</span><span class="n">String</span><span class="o">)</span><span class="n">containerEvent</span><span class="o">,</span> <span class="n">ContainerEvent</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getPayload</span><span class="o">();</span>
                 <span class="k">return</span> <span class="n">jsonParser</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
             <span class="o">}).</span><span class="na">groupByKey</span><span class="o">()</span>  <span class="c1">// the keys are kept so we can group by key to prepare for the tabl</span>
                <span class="o">.</span><span class="na">reduce</span><span class="o">((</span><span class="n">container</span><span class="o">,</span><span class="n">container1</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;received container &quot;</span> <span class="o">+</span> <span class="n">container1</span> <span class="o">);</span>
                    <span class="k">return</span> <span class="n">container1</span><span class="o">;</span>
                <span class="o">},</span>
                     <span class="n">Materialized</span><span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="s">&quot;queryable-container-store&quot;</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>

<p>The trick is to use the <code>reduce()</code> function that get the container and save it to the store that we can specify.</p>
<p>The unit test runs successfully with the command: <code>mvn -Dtest=TestContainerInventory test</code>.</p>
<p>This logic can be integrated in a View class. So we can refactor the test and add new class (see ContainerInventoryView class) to move the logic into the applciation. From a design point of view this class is a DAO. Now that we are not using the Testing tool, we need the real streams.</p>
<p>In class ContainerInventoryView:  <br />
<div class="codehilite"><pre><span></span>   <span class="kd">private</span> <span class="n">KafkaStreams</span> <span class="n">streams</span><span class="o">;</span>
   <span class="c1">// ..</span>
    <span class="n">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="n">ApplicationConfig</span><span class="o">.</span><span class="na">getStreamsProperties</span><span class="o">(</span><span class="s">&quot;container-streams&quot;</span><span class="o">);</span>
    <span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">ConsumerConfig</span><span class="o">.</span><span class="na">AUTO_OFFSET_RESET_CONFIG</span><span class="o">,</span> <span class="s">&quot;earliest&quot;</span><span class="o">);</span>
    <span class="n">streams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KafkaStreams</span><span class="o">(</span><span class="n">buildProcessFlow</span><span class="o">(),</span> <span class="n">props</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">streams</span><span class="o">.</span><span class="na">cleanUp</span><span class="o">();</span> 
        <span class="n">streams</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div></p>
<p>As illustrated above, the streams API is a continuous running Thread, so it needs to be started only one time. We will address scaling separatly.  So we isolate the DAO as a Singleton, and start it when the deployed application starts, via a ServletContextListener. </p>
<div class="codehilite"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EventLoop</span> <span class="kd">implements</span> <span class="n">ServletContextListener</span><span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Initialize the Container consumer</span>
        <span class="n">ContainerInventoryView</span> <span class="n">cView</span> <span class="o">=</span> <span class="o">(</span><span class="n">ContainerInventoryView</span><span class="o">)</span><span class="n">ContainerInventoryView</span><span class="o">.</span><span class="na">instance</span><span class="o">();</span>
        <span class="n">cView</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>

<p>Now we can add the getById operation, package as a war, deploy it to Liberty. </p>
<h3 id="container-to-order-assignment">Container to Order Assignment</h3>
<p>The business logic we want to implement is to get an order with the source pickup city, the type of product, the quantity and the expected pickup date, manage the internal list of containers and search for a container located close to the pickup city from the order.</p>
<p>The test to validate this logic is under <code>kstreams/src/test/java/ut/TestContainerAssignment</code>. </p>
<p>The story will not be completed if we do not talk about how th application get the order. As presented in the design and <a href="https://github.com/ibm-cloud-architecture/refarch-kc-order-ms">order command microservice</a> implementation, when an order is created an event is generated to the <code>orders</code> topic. So we need to add another Streams processing and start the process flow in the context listener.</p>
<p><img alt="" src="../images/container-to-order.png" /></p>
<h3 id="run-tests">Run tests</h3>
<p>Recall with maven we can run all the unit tests, one test and skip integration tests.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Test a unique test</span>
$  mvn -Dtest<span class="o">=</span>TestContainerInventory <span class="nb">test</span>
<span class="c1"># Skip all tests</span>
mvn install -DskipTests
<span class="c1"># Skip integration test</span>
mvn install -DskipITs
<span class="c1"># Run everything</span>
mvn install
</pre></div>

<p>To start the liberty server use the script: <code>./script/startLocalLiberty</code> or <code>mvn liberty:run-server</code></p>
<h2 id="docker-compose-configuration">docker compose configuration</h2>
<p>Replace existing springcontainerms declaration to the following</p>
<div class="codehilite"><pre><span></span>    <span class="nt">containerkstreams</span><span class="p">:</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ibmcase/kc-containerkstreams:latest</span>
        <span class="nt">hostname</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">containerkstreams</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;12080:9080&quot;</span>
        <span class="nt">environment</span><span class="p">:</span>
            <span class="nt">KAFKA_ENV</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${KAFKA_ENV}</span>
            <span class="nt">KAFKA_BROKERS</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${KAFKA_BROKERS}</span>
            <span class="nt">KAFKA_APIKEY</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${KAFKA_APIKEY}</span>
</pre></div>

<h2 id="how-streams-flows-are-resilient">How streams flows are resilient?</h2>
<p>Specifying the replicas factor at the topic level, with a cluster of kafka brokers, combine with transactional event produce, ensure to do not lose messages. The producer client code has the list of all the brokers to contact in case of failure and will try to connect to any broker in the list. </p>
<h2 id="how-to-scale">How to scale?</h2>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../ES2DDD2MS/" title="Analysis and design considerations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Analysis and design considerations
              </span>
            </div>
          </a>
        
        
          <a href="../springboot/" title="Springboot - Kafka and PostgreSQL Implementation" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Springboot - Kafka and PostgreSQL Implementation
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>