



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Reefer Container Management Service</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#container-management-microservice" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="Reefer Container Management Service" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Reefer Container Management Service
            </span>
            <span class="md-header-nav__topic">
              Introduction
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="." title="Reefer Container Management Service" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Reefer Container Management Service
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Introduction
      </label>
    
    <a href="." title="Introduction" class="md-nav__link md-nav__link--active">
      Introduction
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tltr" title="TL;TR" class="md-nav__link">
    TL;TR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" title="Analysis" class="md-nav__link">
    Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#component-view" title="Component view" class="md-nav__link">
    Component view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-inventory" title="Container inventory" class="md-nav__link">
    Container inventory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assign-container-to-order" title="Assign container to order" class="md-nav__link">
    Assign container to order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-learning-to-predict-container-maintenance" title="Machine learning to predict container maintenance" class="md-nav__link">
    Machine learning to predict container maintenance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compendium" title="Compendium" class="md-nav__link">
    Compendium
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="ES2DDD2MS/" title="Analysis and design considerations" class="md-nav__link">
      Analysis and design considerations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Different implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Different implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="kstreams/" title="Kafka Streams Implementation" class="md-nav__link">
      Kafka Streams Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="springboot/" title="Springboot - Kafka and PostgreSQL Implementation" class="md-nav__link">
      Springboot - Kafka and PostgreSQL Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="flask/" title="Python Flask and Kafka Implementation" class="md-nav__link">
      Python Flask and Kafka Implementation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="deployment/" title="Pre-requisites" class="md-nav__link">
      Pre-requisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="springboot/" title="Run spring boot app locally" class="md-nav__link">
      Run spring boot app locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="cicd/" title="Continuous delivery" class="md-nav__link">
      Continuous delivery
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="springboot/#security" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="springboot/#the-integration-tests" title="Run integration tests" class="md-nav__link">
      Run integration tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="predictive-maintenance/" title="Container Predictive Maintenance" class="md-nav__link">
      Container Predictive Maintenance
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tltr" title="TL;TR" class="md-nav__link">
    TL;TR
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" title="Analysis" class="md-nav__link">
    Analysis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#component-view" title="Component view" class="md-nav__link">
    Component view
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#container-inventory" title="Container inventory" class="md-nav__link">
    Container inventory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assign-container-to-order" title="Assign container to order" class="md-nav__link">
    Assign container to order
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-learning-to-predict-container-maintenance" title="Machine learning to predict container maintenance" class="md-nav__link">
    Machine learning to predict container maintenance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compendium" title="Compendium" class="md-nav__link">
    Compendium
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="container-management-microservice">Container management microservice</h1>
<div class="admonition abstract">
<p class="admonition-title">Abstract<p>This project is part of the container shipment implementation solution, and address the Reefer container management microservice implmentaiton. You can read more about the end to end solution <a href="https://ibm-cloud-architecture.github.io/refarch-kc/">in this chapter.</a></p>
</p>
</div>
<h2 id="tltr">TL;TR</h2>
<p>The goal of this Container management service is to support the reefer containers inventory management and to process all the events related to the container entity. We are proposing three different implementations:</p>
<ul>
<li>Springboot and spring kafka template and spring postgreSQL. <a href="springboot/">See this note.</a></li>
<li>Python with Flask and Confluent Kafka API for Python. See <a href="flask/">this description.</a> - NOT DONE YET</li>
<li>Microprofile 2.2 using Kafka Streams. See <a href="kstreams/">this description.</a> - NOT DONE YET</li>
</ul>
<p>We are demonstrating in this project how to transform an event storming analysis to an event-driven microservice implementation and how to address <a href="https://www.ibm.com/cloud/garage/practices/run/reversibility-in-the-cloud">'reversibility'</a> between the different platform. The service is packaged via dockerfile, and helm release is defined to deploy to kubernetes.</p>
<h2 id="analysis">Analysis</h2>
<p>We have a dedicated article on how to transform event storming analysis to microservice, <a href="ES2DDD2MS">here</a>. </p>
<h2 id="component-view">Component view</h2>
<p>As the service needs to offer some basic APIs while consuming and producing events, the code has at least three main components: a kafka consumer, a kafka producer, and a HTTP server exposing the REST APIs. The following diagram illustrates the components involved in this container manager microservice:</p>
<p><img alt="" src="comp-view.png" /></p>
<ul>
<li>A first component is responsible to define and expose APIs via RESTful protocol. It uses the services to delegate business logic implementation.</li>
<li>The service component(s) addresses the business logic implementation and references data access object, and event producer.</li>
<li>The event handler is a kafka consumer which runs continuously to get container events from the <code>container</code> topic. It invokes the service component.</li>
<li>The event producer, produces events of interest to the business function</li>
<li>The DAO implement the persistence for the data received as part of the event payload, or API.</li>
</ul>
<h2 id="container-inventory">Container inventory</h2>
<p>We are providing a tool to publish <code>container created</code> events to the Kafka <code>containers</code> topic. The python code is in the root project <code>refarch-kc</code> under the <a href="https://github.com/ibm-cloud-architecture/refarch-kc/tree/master/itg-tests/ContainersPython"><code>itg-tests/ContainersPython</code> folder</a>. The <code>addContainer.sh</code> uses our Python docker image to create a container and send it to kafka.</p>
<p>When Kafka runs on IBM Cloud use:
<div class="codehilite"><pre><span></span>./addContainer.sh IBMCLOUD
</pre></div></p>
<p>If you want to run using a kafka running on your computer with docker-compose:</p>
<div class="codehilite"><pre><span></span>./addContainer.sh LOCAL 
</pre></div>

<div class="codehilite"><pre><span></span>./addContainer.sh MINIKUBE
</pre></div>

<p>or with minikube:</p>
<p>And for ICP</p>
<div class="codehilite"><pre><span></span>./addContainer.sh ICP
</pre></div>

<p>The trace from the python execution looks like:
<div class="codehilite"><pre><span></span>Create container
{&#39;containerID&#39;: &#39;itg-C02&#39;, &#39;timestamp&#39;: 1559868907, &#39;type&#39;: &#39;ContainerAdded&#39;, &#39;payload&#39;: {&#39;containerID&#39;: &#39;itg-C02&#39;, &#39;type&#39;: &#39;Reefer&#39;, &#39;status&#39;: &#39;Empty&#39;, &#39;latitude&#39;: 37.8, &#39;longitude&#39;: -122.25, &#39;capacity&#39;: 110, &#39;brand&#39;: &#39;itg-brand&#39;}}
Message delivered to containers [0]
</pre></div></p>
<p>While on the running Java microservice, you will could see the service consumed the message:</p>
<div class="codehilite"><pre><span></span>INFO 47 --- [ingConsumer-C-1] c.l.k.c.kafka.ContainerConsumer          : Received container event: {&quot;containerID&quot;: &quot;itg-C02&quot;, &quot;timestamp&quot;: 1559868907, &quot;type&quot;: &quot;ContainerAdded&quot;, &quot;payload&quot;: {&quot;containerID&quot;: &quot;itg-C02&quot;, &quot;type&quot;: &quot;Reefer&quot;, &quot;status&quot;: &quot;Empty&quot;, &quot;latitude&quot;: 37.8, &quot;longitude&quot;: -122.25, &quot;capacity&quot;: 110, &quot;brand&quot;: &quot;itg-brand&quot;}}
</pre></div>

<p>It is also possible to start the python environment with Docker, and then inside the container bash session use python as you will do in your own computer. 
<div class="codehilite"><pre><span></span><span class="nb">source</span> ../../scripts/setenv.sh
docker run -e <span class="nv">KAFKA_BROKERS</span><span class="o">=</span><span class="nv">$KAFKA_BROKERS</span> -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/home --network<span class="o">=</span>docker_default -ti ibmcase/python bash
root@2f049cb7b4f2:/ <span class="nb">cd</span> home
root@2f049cb7b4f2:/ python ProduceContainerCreatedEvent.py 
</pre></div></p>
<h2 id="assign-container-to-order">Assign container to order</h2>
<p>The implementation will search the list of containers closed to the source location. We simplify the implementation by assuming mapping container (longitude, latitude) position to be in an area close to the harbor in the same region as the pickup location. We do not manage the time when the container will be there. We assume containers are at the location at the time of the order is processed, is close enought to the time of the pickup. In a future iteration, we may fine tune that if we can make it simple.</p>
<p>The output of this assignment processing is an event to the <code>orders</code> topic.</p>
<p>See <a href="./springboot/#add-the-get-containers-api">implementation details in this note</a>.</p>
<h2 id="machine-learning-to-predict-container-maintenance">Machine learning to predict container maintenance</h2>
<p>Finally, an important element of this project is the integration of Kafka topic as datasource to develop a machine learning model for the container predictive maintenance scoring. See details in <a href="./metrics">this note</a>.</p>
<h2 id="compendium">Compendium</h2>
<ul>
<li><a href="http://postgresguide.com/sql/select.html">Postgresql tutorial</a></li>
<li><a href="https://www.postgresql.org/docs/9.2/app-psql.html">psql commands</a></li>
<li><a href="https://docs.spring.io/spring-kafka/reference/">Spring boot kafka documentation</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="ES2DDD2MS/" title="Analysis and design considerations" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Analysis and design considerations
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
    
  </body>
</html>