



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>Run spring boot app locally - Reefer Container Management Service</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#springboot-kafka-container-microservice" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Reefer Container Management Service" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Reefer Container Management Service
            </span>
            <span class="md-header-nav__topic">
              
                Run spring boot app locally
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Reefer Container Management Service" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Reefer Container Management Service
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../ES2DDD2MS/" title="Analysis and design considerations" class="md-nav__link">
      Analysis and design considerations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Different implementations
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Different implementations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../kstreams/" title="Kafka Streams Implementation" class="md-nav__link">
      Kafka Streams Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="./" title="Springboot - Kafka and PostgreSQL Implementation" class="md-nav__link">
      Springboot - Kafka and PostgreSQL Implementation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../flask/" title="Python Flask and Kafka Implementation" class="md-nav__link">
      Python Flask and Kafka Implementation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../deployment/" title="Pre-requisites" class="md-nav__link">
      Pre-requisites
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Run spring boot app locally
      </label>
    
    <a href="./" title="Run spring boot app locally" class="md-nav__link md-nav__link--active">
      Run spring boot app locally
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#starting-code" class="md-nav__link">
    Starting code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-from-spring-initializer" class="md-nav__link">
    Start from Spring initializer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-from-ibm-cloud-starter-kit" class="md-nav__link">
    Start from IBM Cloud Starter Kit.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-pomxml" class="md-nav__link">
    Update pom.xml
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-with-maven" class="md-nav__link">
    Build with maven
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-with-docker" class="md-nav__link">
    Build with docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-spring-boot-basis" class="md-nav__link">
    Some Spring boot basis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-implementation" class="md-nav__link">
    Code implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-get-containers-api" class="md-nav__link">
    Add the get "/containers"  API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-your-local-test-environment" class="md-nav__link">
    Preparing your local test environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-integration-tests" class="md-nav__link">
    The integration tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#console-6-create-order" class="md-nav__link">
    Console 6: Create order
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-5-consumer-orders" class="md-nav__link">
    Console 5: consumer orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-1-app" class="md-nav__link">
    Console 1: app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-3-containers-consumer" class="md-nav__link">
    Console 3: Containers consumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-2" class="md-nav__link">
    Console 2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listening-to-container-events" class="md-nav__link">
    Listening to container events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listening-to-order-event" class="md-nav__link">
    Listening to Order Event
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    Security
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manually-deploy-to-iks" class="md-nav__link">
    Manually deploy to IKS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perform-integration-tests-from-local-to-remote-ibm-cloud-deployment" class="md-nav__link">
    Perform integration tests from local to remote IBM Cloud deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encountered-issues-with-some-solution" class="md-nav__link">
    Encountered issues with some solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cicd/" title="Continuous delivery" class="md-nav__link">
      Continuous delivery
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="#security" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="#the-integration-tests" title="Run integration tests" class="md-nav__link">
      Run integration tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-reefer-ml/" title="Reefer Container Predictive Maintenance" class="md-nav__link">
      Reefer Container Predictive Maintenance
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#starting-code" class="md-nav__link">
    Starting code
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-from-spring-initializer" class="md-nav__link">
    Start from Spring initializer
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-from-ibm-cloud-starter-kit" class="md-nav__link">
    Start from IBM Cloud Starter Kit.
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-pomxml" class="md-nav__link">
    Update pom.xml
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#build" class="md-nav__link">
    Build
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build-with-maven" class="md-nav__link">
    Build with maven
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-with-docker" class="md-nav__link">
    Build with docker
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-spring-boot-basis" class="md-nav__link">
    Some Spring boot basis
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-implementation" class="md-nav__link">
    Code implementation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-the-get-containers-api" class="md-nav__link">
    Add the get "/containers"  API
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-your-local-test-environment" class="md-nav__link">
    Preparing your local test environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-integration-tests" class="md-nav__link">
    The integration tests
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#console-6-create-order" class="md-nav__link">
    Console 6: Create order
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-5-consumer-orders" class="md-nav__link">
    Console 5: consumer orders
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-1-app" class="md-nav__link">
    Console 1: app
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-3-containers-consumer" class="md-nav__link">
    Console 3: Containers consumer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#console-2" class="md-nav__link">
    Console 2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listening-to-container-events" class="md-nav__link">
    Listening to container events
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#listening-to-order-event" class="md-nav__link">
    Listening to Order Event
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#security" class="md-nav__link">
    Security
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manually-deploy-to-iks" class="md-nav__link">
    Manually deploy to IKS
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#perform-integration-tests-from-local-to-remote-ibm-cloud-deployment" class="md-nav__link">
    Perform integration tests from local to remote IBM Cloud deployment
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encountered-issues-with-some-solution" class="md-nav__link">
    Encountered issues with some solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/edit/master/docs/springboot/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="springboot-kafka-container-microservice">Springboot - Kafka container microservice</h1>
<p>This chapter presents how to develop the Reefer container manager service using Spring boot, Kafka template and PostgreSQL, Hibernate JPA and Spring data template. This is another way to implement the same specifications and helps us to assess the different technologies to develop event-driven cloud native microservice. The user stories to support are described in <a href="..">this section</a>.</p>
<p><img alt="" src="spr-components.png" /></p>
<p>The application is built around the following components:</p>
<ul>
<li>A Postgresql repository to support CRUD operations for Reefer containers</li>
<li>A kafka consumer for container events, to get the container data and call the repository to save new container or update existing one.</li>
<li>A new Order consumer to get order created event, and then search matching container(s) taking into account the product type, the quantity and the pickup address. It uses the postgresql repository to find the list of Reefer candidates.</li>
<li>An order producer to send containerId - Order ID assignment event to the orders topic using order ID as key</li>
<li>A container producer to send containerId - Order ID assignment event to the container topic, using container ID as key.</li>
<li>Expose RESTful APIs to be a reusable service too.</li>
</ul>
<p>We are addressing one of the characteristics of microservice 'reversibility' with this project: the programming style and deployment to different cloud platform. We try to answer the following questions:</p>
<ul>
<li>How to deploy to IBM Cloud kubernetes service and in one command, taking the same code version and deploying it to IBM Cloud Private behind the firewall with all the related components available on that plaform?</li>
<li>How to adopt control the dependencies and the configuration factors (See <a href="https://12factor.net/">The 12 factors app</a>) to facilitate reversibility?</li>
</ul>
<h2 id="starting-code">Starting code</h2>
<p>We have found it is necessary to combine different starter code as the basic spring boot generated code is not useful.</p>
<h3 id="start-from-spring-initializer">Start from Spring initializer</h3>
<p>Using the <a href="https://start.spring.io/">Spring Code generator</a> we created the base project.</p>
<p><img alt="" src="spr-initializr.png" /></p>
<p>The generated code is really minimum and the interesting part is the maven <code>pom.xml</code> dependencies. We do not have code related to the selected dependant, no dockerfile and all the goodies to deploy to Kubernetes cluster.</p>
<p>It is more convenient to start from IBM Cloud starter kit and modify the generared <code>pom.xml</code> with the needed dependencies...</p>
<h2 id="start-from-ibm-cloud-starter-kit">Start from IBM Cloud Starter Kit.</h2>
<p>Once logged to IBM Cloud, create a resource and select <code>Starter kit</code> in the Catalog, then the <code>Java microservice with Spring</code> kit.</p>
<p><img alt="" src="spr-ic-start.png" /></p>
<p>The application is created, we can download the code or create a toolchain so we can use a continuous integration and deployment to an existing IBM Kubernetes Service.</p>
<p><img alt="" src="spr-ic-app.png" /></p>
<p>Now the code repository has Dockerfile, helm chart, CLI configuration, scripts and other manifests... We can build existing code and run it with the following commands:</p>
<div class="codehilite"><pre><span></span>$ mvn clean package
$ java -jar target/SpringContainerMS-1.0-SNAPSHOT.jar application.SBApplication
</pre></div>

<p>Pointing to http://localhost:8080/ will bring the first page. It works! So let break it.</p>
<p>If you did not try it before, and if you are using <a href="https://www.eclipse.org/">Eclipse</a> last release, you can install Eclipse Spring IDE plugin: open Eclipse Marketplace and search for Spring IDE, and then download release 4.x:</p>
<p><img alt="" src="eclipse-spr-ide.png" /></p>
<p>To verify the installation, importing our project as a 'maven' project will let you see the different options like spring boot starters election, etc...</p>
<p>The tool is also available for IDE visual studio code. See <a href="https://spring.io/tools">this note</a> for Spring toools.</p>
<h3 id="update-pomxml">Update pom.xml</h3>
<p>The generated dependencies include Spring boot starter web code, hystrix for circuit breaker and retries, and testing. We need to add kafka and postgreSQL dependencies and re-run <code>mvn install</code>.
<div class="codehilite"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.kafka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-kafka<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.kafka<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-kafka-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div></p>
<h2 id="build">Build</h2>
<h3 id="build-with-maven">Build with maven</h3>
<div class="codehilite"><pre><span></span><span class="n">cd</span> <span class="n">SpringContainerMS</span>
<span class="n">mvn</span> <span class="n">package</span>
</pre></div>

<h3 id="build-with-docker">Build with docker</h3>
<p>To support flexible CI/CD deployment and run locally we propose to use Docker <a href="https://docs.docker.com/develop/develop-images/multistage-build/">multi-stage build</a>.</p>
<p>As part of the CI/CD design, there is an important subject to address: how to support integration tests? Unit tests focus on validating the business logic, while integration tests validate the end to end integration of the microservice with its dependants services and products. We separated the unit tests and integration tests in their own Java packages. Later it will be more appropriate to have a separate code repository for integration tests (we stated this approach in the <code>refarch-kc</code> project under the <code>itg-tests</code> folder).</p>
<p>Integration tests in this project access remote postegresql server. When the server is in IBM Cloud as part of the postgresql service, a SSL Certificate is defined as part of the service credentials. When building with Docker multi-stage this means the build stage has to get certificate in the Java TrustStore so tests are successful. We burnt a lot of time to make it working. We recommend reading the <a href="#security">security section</a> below to see what commands to run to get certificate in good format and create a truststore. Those commands have to be done in the dockerfile too and certificate, URL, user, password has to be injected using Dockerfile arguments and then environment variables.</p>
<p>See the <code>scripts/buildDocker.sh</code> to assess the docker build parameters used. And then how to manage the certificate creation into the Java TrustStore using scripts like <code>add_certificates.sh</code>. This script needs to be executed before the maven build so any integration tests that need to access the remote Postgresql server will not fail with SSL handcheck process. And it needs to be done in the docker final image as part of the startup of the spring boot app (see <code>startup.sh</code>).</p>
<h2 id="some-spring-boot-basis">Some Spring boot basis</h2>
<p>We encourage you to go over the different tutorials from spring.io. We followed the following ones to be sure we have some good understanding of the basic components:</p>
<ul>
<li><a href="https://spring.io/guides/gs/spring-boot/">Springboot</a>. Helps to start quickly application. The first class as the main function and run the SpringApplcation. The <code>@SpringBootApplication</code> annotation adds configuration to get the spring bean definitions, and auto configure the bean jars needed. As we specified the <code>pring-boot-starter-web</code> artifact in the dependencoes the application is a web MVC and includes a Dispatcher servlet.</li>
<li><a href="https://spring.io/guides/gs/accessing-data-jpa/">Data with JPA</a> addresses creating entity beans, repository as data access object and queries.</li>
<li><a href="https://www.callicoder.com/spring-boot-jpa-hibernate-postgresql-restful-crud-api-example/">Spring Boot, PostgreSQL, JPA, Hibernate RESTful CRUD API Example from Callicoder</a></li>
<li><a href="https://spring.io/projects/spring-kafka">Spring Kafka</a></li>
</ul>
<h2 id="code-implementation">Code implementation</h2>
<h3 id="add-the-get-containers-api">Add the get "/containers"  API</h3>
<p>We want to start by the get reefer containers test and then implement a simple container controller bean with the CRUD operations. Spring takes into account the package names to manage its dependencies and settings. The test looks like below:</p>
<p><div class="codehilite"><pre><span></span><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetContainers</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="s">&quot;http://localhost:&quot;</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">&quot;/containers&quot;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">endpoint</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">assertTrue</span><span class="o">(</span><span class="s">&quot;Invalid response from server : &quot;</span> <span class="o">+</span> <span class="n">response</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;[&quot;</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
Spring Boot provides a @SpringBootTest annotation to build an application context used for the test. Below we specify to use Spring unit test runner, and to load the configuration from the main application class. The server used above is auto injected by the runner.</p>
<div class="codehilite"><pre><span></span><span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span><span class="o">=</span><span class="n">SBApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="n">WebEnvironment</span><span class="o">.</span><span class="na">RANDOM_PORT</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContainerAPITest</span> <span class="o">{</span>
     <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">TestRestTemplate</span> <span class="n">server</span><span class="o">;</span>

    <span class="nd">@LocalServerPort</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
</pre></div>

<p>The next step is to implement the controller class under the package <code>ibm.labs.kc.containermgr.rest.containers</code>.</p>
<div class="codehilite"><pre><span></span><span class="kn">package</span> <span class="nn">ibm.labs.kc.containermgr.rest.containers</span><span class="o">;</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContainerController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;containers&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ContainerEntity</span><span class="o">&gt;</span> <span class="nf">getAllContainers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ContainerEntity</span><span class="o">&gt;;</span>
    <span class="o">}</span>
</pre></div>

<p>The ContainerEntity is a class with JPA annotations, used to control the object to table mapping. Below is a <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/14cc515787a7aeeebf38c703473ab32622c56b93/SpringContainerMS/src/main/java/ibm/labs/kc/containermgr/model/ContainerEntity.java#L21-L47">simple entity definition</a>:</p>
<div class="codehilite"><pre><span></span><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;containers&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContainerEntity</span> <span class="kd">implements</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">status</span><span class="o">;</span>
    <span class="kd">protected</span> <span class="n">String</span> <span class="n">brand</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

<p>Once we have defined the entity attributes and how it is mapped to the table column, the next major step is to add a repository class: <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/SpringContainerMS/src/main/java/ibm/labs/kc/containermgr/dao/ContainerRepository.java">ContainerRepository.java</a> and configure the application to use Postgress dialect so JPA can generate compatible DDLs. The repository is scrary easy, it just extends a base JpaRepository and specifies the primary key used as ID and the type of record as ContainerEntity.</p>
<div class="codehilite"><pre><span></span><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ContainerRepository</span> <span class="kd">extends</span> <span class="n">JpaRepository</span><span class="o">&lt;</span><span class="n">ContainerEntity</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;{}</span>
</pre></div>

<p>Spring makes it magic to add save, findById, findAll... operations transparently. So now we can @Autowrite this repository into the controller class and add the integration tests. The test is in the Junit test class: <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/SpringContainerMS/src/test/java/it/container/PostgreSqlTest.java">PostgreSqlTest</a>. In fact, for test reason we want to inject Mockup class in unit test via the controller contructor.</p>
<div class="codehilite"><pre><span></span><span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAccessToRemoteDBSpringDatasource</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">ContainerEntity</span><span class="o">&gt;</span> <span class="n">cOut</span> <span class="o">=</span> <span class="n">containerRepo</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">&quot;c1&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">cOut</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">ContainerEntity</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContainerEntity</span><span class="o">(</span><span class="s">&quot;c1&quot;</span><span class="o">,</span><span class="s">&quot;Brand&quot;</span><span class="o">,</span><span class="s">&quot;Reefer&quot;</span><span class="o">,</span><span class="mi">100</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
            <span class="n">c</span><span class="o">.</span><span class="na">setCreatedAt</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
            <span class="n">c</span><span class="o">.</span><span class="na">setUpdatedAt</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getCreatedAt</span><span class="o">());</span>
            <span class="n">containerRepo</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="c1">// add asserts...</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>Finally the controller is integrating the repository:</p>
<div class="codehilite"><pre><span></span>    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ContainerRepository</span> <span class="n">containerRepository</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/containers/{containerId}&quot;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">ContainerEntity</span> <span class="nf">getContainerById</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="n">String</span> <span class="n">containerId</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">containerRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">containerId</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span>
         <span class="k">new</span> <span class="n">ResourceNotFoundException</span><span class="o">(</span><span class="s">&quot;Container not found with id &quot;</span> <span class="o">+</span> <span class="n">containerId</span><span class="o">));</span>
    <span class="o">}</span>
</pre></div>

<p>The test fails as it is missing the configuration to the postsgresql service. As we do not want to hardcode the password and URL end point or share secret in public github we define the configuration using environment variables. See the <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/SpringContainerMS/src/main/resources/application.properties">application.properties</a> file. We have two choices for the Postgresql service: one using IBM Cloud and one running local docker image.</p>
<p>To export the different environment variables we have a <code>setenv.sh</code> script (which we have defined a template for, named setenv.sh.tmpl in the main repository <code>refarch-kc</code>) with one argument used to control the different environment varaibles for Kafka and Postgresql. The script argument should be one of LOCAL (default if no argument is given), MINIKUBE, IBMCLOUD, or ICP.</p>
<p>To execute against the remote postgresql and Kafka brokers use:
<div class="codehilite"><pre><span></span><span class="c1"># Under the SpringContainerMS folder</span>
$ <span class="nb">source</span> ../../refarch-kc/scripts/setenv.sh IBMCLOUD
$ mvn <span class="nb">test</span>
</pre></div></p>
<p>To execute against a local kafka - postesgresql docker images, first you need to start the backend services: In the <code>refarch-kc</code> project, under the <code>docker</code> folder use the docker compose file:backbone-compose.yml (See <a href="https://ibm-cloud-architecture.github.io/refarch-kc/deployments/local/#start-kafka-zookeeper-and-postgresql">this note for detail</a>):</p>
<p>and then
<div class="codehilite"><pre><span></span><span class="c1"># Under the SpringContainerMS folder</span>
$ <span class="nb">source</span> ../../refarch-kc/scripts/setenv.sh LOCAL
$ mvn <span class="nb">test</span>
</pre></div></p>
<p>After the tests run successfully with a valid connection to IBM cloud, launching the spring boot app location and going to http://localhost:8080/containers/c1 will give you the data for the Container "c1".</p>
<h2 id="preparing-your-local-test-environment">Preparing your local test environment</h2>
<p>We propose to use the local deployment to do unit tests and integration tests. The integration test for this application is quite complex and we propose to use a diagram to illustrate the components involved and how to start them.</p>
<p>First be sure your back end services run: It will start zookeeper, kafka and postgresql. You need the <a href="https://ibm-cloud-architecture.github.io/refarch-kc/">refarch-kc main project for that</a> which normally can be in one folder above this current project. To start the backend:</p>
<div class="codehilite"><pre><span></span>$ <span class="nb">cd</span> refarch-kc
$ ./scripts/local/launch.sh BACKEND

Starting docker_zookeeper1_1  ... <span class="k">done</span>
Creating docker_postgres-db_1 ... <span class="k">done</span>
Starting docker_kafka1_1      ... <span class="k">done</span>
</pre></div>

<blockquote>
<p>if you need to restart from empty topics, delete the kafka1 and zookeeper1 folders under <code>refarch-kc/docker</code> and restart the backend services.</p>
</blockquote>
<h2 id="the-integration-tests">The integration tests</h2>
<p><img alt="" src="itg-tests.png" /></p>
<p>To perform the integration test step by step do the following:</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Description</th>
<th>Run</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Springboot app which includes kafka consumers and producers, REST API and postgresql DAO</td>
<td>./scripts/run.sh</td>
</tr>
<tr>
<td>2</td>
<td><strong>psql</strong> to access postgresql DB</td>
<td>From the refarch-kc-container-ms folder do ./scripts/start_psql</td>
</tr>
<tr>
<td>3</td>
<td><strong>containers</strong> consumer. To trace the <em>containers</em> topics. This code is in refarch-kc project in <code>itg-tests/ContainersPython</code> folder.</td>
<td>Use a Terminal console: refarch-kc/itg-tests/ContainersPython/ runContainerConsumer.sh LOCAL c01</td>
</tr>
<tr>
<td>4</td>
<td>container events producer. To generate events. This code is in refarch-kc project in <code>itg-tests/ContainersPython</code> folder.</td>
<td>Use a Terminal console: refarch-kc/itg-tests/ContainersPython/ addContainer.sh LOCAL c01</td>
</tr>
<tr>
<td>5</td>
<td>orders consumer. To trace the <em>orders</em> topics. This code is in refarch-kc project in <code>itg-tests/OrdersPython</code> folder.</td>
<td>Use a Terminal console: refarch-kc/itg-tests/OrdersPython/ runOrderConsumer.sh LOCAL order01</td>
</tr>
<tr>
<td>6</td>
<td>orders events producer. To generate order events. This code is in refarch-kc project in <code>itg-tests/OrdersPython</code> folder.</td>
<td>Use a Terminal console: refarch-kc/itg-tests/OrdersPython/ addOrder.sh LOCAL order01</td>
</tr>
</tbody>
</table>
<p>Here is an example of traces after sending 2 container creation events in terminal console (#3):</p>
<div class="codehilite"><pre><span></span><span class="o">@@@</span> <span class="n">pollNextOrder</span> <span class="n">containers</span> <span class="n">partition</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">at</span> <span class="k">offset</span> <span class="mi">4</span> <span class="k">with</span> <span class="k">key</span> <span class="n">b</span><span class="s1">&#39;itg-C02&#39;</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-C02&quot;</span><span class="p">,</span> <span class="ss">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1556250004</span><span class="p">,</span> <span class="ss">&quot;type&quot;</span><span class="p">:</span> <span class="ss">&quot;ContainerAdded&quot;</span><span class="p">,</span> <span class="ss">&quot;payload&quot;</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-C02&quot;</span><span class="p">,</span> <span class="ss">&quot;type&quot;</span><span class="p">:</span> <span class="ss">&quot;Reefer&quot;</span><span class="p">,</span> <span class="ss">&quot;status&quot;</span><span class="p">:</span> <span class="ss">&quot;Empty&quot;</span><span class="p">,</span> <span class="ss">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="ss">&quot;longitude&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="ss">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="p">,</span> <span class="ss">&quot;brand&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-brand&quot;</span><span class="err">}}</span>
<span class="o">@@@</span> <span class="n">pollNextOrder</span> <span class="n">containers</span> <span class="n">partition</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">at</span> <span class="k">offset</span> <span class="mi">5</span> <span class="k">with</span> <span class="k">key</span> <span class="n">b</span><span class="s1">&#39;itg-c03&#39;</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-c03&quot;</span><span class="p">,</span> <span class="ss">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1556250673</span><span class="p">,</span> <span class="ss">&quot;type&quot;</span><span class="p">:</span> <span class="ss">&quot;ContainerAdded&quot;</span><span class="p">,</span> <span class="ss">&quot;payload&quot;</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-c03&quot;</span><span class="p">,</span> <span class="ss">&quot;type&quot;</span><span class="p">:</span> <span class="ss">&quot;Reefer&quot;</span><span class="p">,</span> <span class="ss">&quot;status&quot;</span><span class="p">:</span> <span class="ss">&quot;Empty&quot;</span><span class="p">,</span> <span class="ss">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">37</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="ss">&quot;longitude&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="ss">&quot;capacity&quot;</span><span class="p">:</span> <span class="mi">110</span><span class="p">,</span> <span class="ss">&quot;brand&quot;</span><span class="p">:</span> <span class="ss">&quot;itg-brand&quot;</span><span class="err">}}</span>
</pre></div>

<p>Which can be verified in the (#1) trace:</p>
<div class="codehilite"><pre><span></span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">16</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">11</span><span class="p">.</span><span class="mi">245</span>  <span class="n">INFO</span> <span class="mi">17734</span> <span class="c1">--- [ingConsumer-C-1] c.l.k.c.kafka.ContainerConsumer          : Received container event: {&quot;containerID&quot;: &quot;itg-C02&quot;, &quot;timestamp&quot;: 1556250004, &quot;type&quot;: &quot;ContainerAdded&quot;, &quot;payload&quot;: {&quot;containerID&quot;: &quot;itg-C02&quot;, &quot;type&quot;: &quot;Reefer&quot;, &quot;status&quot;: &quot;Empty&quot;, &quot;latitude&quot;: 37.8, &quot;longitude&quot;: -122.25, &quot;capacity&quot;: 110, &quot;brand&quot;: &quot;itg-brand&quot;}}</span>
</pre></div>

<p>And in console for container producer (#4)</p>
<div class="codehilite"><pre><span></span><span class="k">Create</span> <span class="n">container</span>
<span class="err">{</span><span class="s1">&#39;containerID&#39;</span><span class="p">:</span> <span class="s1">&#39;itg-C02&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="mi">1556250004</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ContainerAdded&#39;</span><span class="p">,</span> <span class="s1">&#39;payload&#39;</span><span class="p">:</span> <span class="err">{</span><span class="s1">&#39;containerID&#39;</span><span class="p">:</span> <span class="s1">&#39;itg-C02&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Reefer&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;Empty&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="mi">37</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span> <span class="s1">&#39;capacity&#39;</span><span class="p">:</span> <span class="mi">110</span><span class="p">,</span> <span class="s1">&#39;brand&#39;</span><span class="p">:</span> <span class="s1">&#39;itg-brand&#39;</span><span class="err">}}</span>
<span class="n">Message</span> <span class="n">delivered</span> <span class="k">to</span> <span class="n">containers</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

<p>Finally in the psql console:</p>
<div class="codehilite"><pre><span></span><span class="n">postgres</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">containers</span><span class="p">;</span>
   <span class="n">id</span>    <span class="o">|</span>   <span class="n">brand</span>   <span class="o">|</span> <span class="n">capacity</span> <span class="o">|</span>       <span class="n">created_at</span>        <span class="o">|</span> <span class="n">current_city</span> <span class="o">|</span> <span class="n">latitude</span> <span class="o">|</span> <span class="n">longitude</span> <span class="o">|</span> <span class="n">status</span> <span class="o">|</span>  <span class="k">type</span>  <span class="o">|</span>       <span class="n">updated_at</span>
<span class="c1">---------+-----------+----------+-------------------------+--------------+----------+-----------+--------+--------+-------------------------</span>

 <span class="n">itg</span><span class="o">-</span><span class="n">C02</span> <span class="o">|</span> <span class="n">itg</span><span class="o">-</span><span class="n">brand</span> <span class="o">|</span>      <span class="mi">110</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">885</span> <span class="o">|</span> <span class="n">Oakland</span>      <span class="o">|</span>     <span class="mi">37</span><span class="p">.</span><span class="mi">8</span> <span class="o">|</span>   <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span> <span class="o">|</span>      <span class="mi">1</span> <span class="o">|</span> <span class="n">Reefer</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">04</span><span class="p">.</span><span class="mi">579</span>
 <span class="n">itg</span><span class="o">-</span><span class="n">c03</span> <span class="o">|</span> <span class="n">itg</span><span class="o">-</span><span class="n">brand</span> <span class="o">|</span>      <span class="mi">110</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">20</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">13</span><span class="p">.</span><span class="mi">424</span> <span class="o">|</span> <span class="n">Oakland</span>      <span class="o">|</span>     <span class="mi">37</span><span class="p">.</span><span class="mi">8</span> <span class="o">|</span>   <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span> <span class="o">|</span>      <span class="mi">1</span> <span class="o">|</span> <span class="n">Reefer</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">20</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">13</span><span class="p">.</span><span class="mi">424</span>
</pre></div>

<blockquote>
<p>The capacity is at maximum and the status = 1 is for empty container.</p>
</blockquote>
<p>When an order is created in console #6, a matching container is found and 2 events are created to present the container id and order id in both topics: containers and orders:</p>
<h4 id="console-6-create-order">Console 6: Create order</h4>
<div class="codehilite"><pre><span></span>$ ./addOrder.sh LOCAL order02

Create order
<span class="o">{</span><span class="s1">&#39;orderID&#39;</span>: <span class="s1">&#39;order04&#39;</span>, <span class="s1">&#39;timestamp&#39;</span>: <span class="m">1556252841</span>, <span class="s1">&#39;type&#39;</span>: <span class="s1">&#39;OrderCreated&#39;</span>, <span class="s1">&#39;payload&#39;</span>: <span class="o">{</span><span class="s1">&#39;orderID&#39;</span>: <span class="s1">&#39;order04&#39;</span>, <span class="s1">&#39;productID&#39;</span>: <span class="s1">&#39;FreshFoodItg&#39;</span>, <span class="s1">&#39;customerID&#39;</span>: <span class="s1">&#39;Customer007&#39;</span>, <span class="s1">&#39;quantity&#39;</span>: <span class="m">180</span>, <span class="s1">&#39;pickupAddress&#39;</span>: <span class="o">{</span><span class="s1">&#39;street&#39;</span>: <span class="s1">&#39;astreet&#39;</span>, <span class="s1">&#39;city&#39;</span>: <span class="s1">&#39;Oakland&#39;</span>, <span class="s1">&#39;country&#39;</span>: <span class="s1">&#39;USA&#39;</span>, <span class="s1">&#39;state&#39;</span>: <span class="s1">&#39;CA&#39;</span>, <span class="s1">&#39;zipcode&#39;</span>: <span class="s1">&#39;95000&#39;</span><span class="o">}</span>, <span class="s1">&#39;destinationAddress&#39;</span>: <span class="o">{</span><span class="s1">&#39;street&#39;</span>: <span class="s1">&#39;bstreet&#39;</span>, <span class="s1">&#39;city&#39;</span>: <span class="s1">&#39;Beijing&#39;</span>, <span class="s1">&#39;country&#39;</span>: <span class="s1">&#39;China&#39;</span>, <span class="s1">&#39;state&#39;</span>: <span class="s1">&#39;NE&#39;</span>, <span class="s1">&#39;zipcode&#39;</span>: <span class="s1">&#39;09000&#39;</span><span class="o">}</span>, <span class="s1">&#39;pickupDate&#39;</span>: <span class="s1">&#39;2019-05-25&#39;</span>, <span class="s1">&#39;expectedDeliveryDate&#39;</span>: <span class="s1">&#39;2019-06-25&#39;</span><span class="o">}}</span>
Message delivered to orders <span class="o">[</span><span class="m">0</span><span class="o">]</span>
</pre></div>

<h4 id="console-5-consumer-orders">Console 5: consumer orders</h4>
<div class="codehilite"><pre><span></span>    <span class="n">value</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;orderID&quot;</span><span class="p">:</span> <span class="ss">&quot;order04&quot;</span><span class="p">,</span> <span class="ss">&quot;timestamp&quot;</span><span class="p">:</span> <span class="mi">1556252841</span><span class="p">,</span> <span class="ss">&quot;type&quot;</span><span class="p">:</span> <span class="ss">&quot;OrderCreated&quot;</span><span class="p">,</span> <span class="ss">&quot;payload&quot;</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;orderID&quot;</span><span class="p">:</span> <span class="ss">&quot;order04&quot;</span><span class="p">,</span> <span class="ss">&quot;productID&quot;</span><span class="p">:</span> <span class="ss">&quot;FreshFoodItg&quot;</span><span class="p">,</span> <span class="ss">&quot;customerID&quot;</span><span class="p">:</span> <span class="ss">&quot;Customer007&quot;</span><span class="p">,</span> <span class="ss">&quot;quantity&quot;</span><span class="p">:</span> <span class="mi">180</span><span class="p">,</span> <span class="ss">&quot;pickupAddress&quot;</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;street&quot;</span><span class="p">:</span> <span class="ss">&quot;astreet&quot;</span><span class="p">,</span> <span class="ss">&quot;city&quot;</span><span class="p">:</span> <span class="ss">&quot;Oakland&quot;</span><span class="p">,</span> <span class="ss">&quot;country&quot;</span><span class="p">:</span> <span class="ss">&quot;USA&quot;</span><span class="p">,</span> <span class="ss">&quot;state&quot;</span><span class="p">:</span> <span class="ss">&quot;CA&quot;</span><span class="p">,</span> <span class="ss">&quot;zipcode&quot;</span><span class="p">:</span> <span class="ss">&quot;95000&quot;</span><span class="err">}</span><span class="p">,</span> <span class="ss">&quot;destinationAddress&quot;</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;street&quot;</span><span class="p">:</span> <span class="ss">&quot;bstreet&quot;</span><span class="p">,</span> <span class="ss">&quot;city&quot;</span><span class="p">:</span> <span class="ss">&quot;Beijing&quot;</span><span class="p">,</span> <span class="ss">&quot;country&quot;</span><span class="p">:</span> <span class="ss">&quot;China&quot;</span><span class="p">,</span> <span class="ss">&quot;state&quot;</span><span class="p">:</span> <span class="ss">&quot;NE&quot;</span><span class="p">,</span> <span class="ss">&quot;zipcode&quot;</span><span class="p">:</span> <span class="ss">&quot;09000&quot;</span><span class="err">}</span><span class="p">,</span> <span class="ss">&quot;pickupDate&quot;</span><span class="p">:</span> <span class="ss">&quot;2019-05-25&quot;</span><span class="p">,</span> <span class="ss">&quot;expectedDeliveryDate&quot;</span><span class="p">:</span> <span class="ss">&quot;2019-06-25&quot;</span><span class="err">}}</span>
<span class="o">@@@</span> <span class="n">pollNextOrder</span> <span class="n">orders</span> <span class="n">partition</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">at</span> <span class="k">offset</span> <span class="mi">5</span> <span class="k">with</span> <span class="k">key</span> <span class="n">b</span><span class="s1">&#39;order04&#39;</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;orderID&quot;</span><span class="p">:</span><span class="ss">&quot;order04&quot;</span><span class="p">,</span><span class="ss">&quot;payload&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span><span class="ss">&quot;itg-c03&quot;</span><span class="p">,</span><span class="ss">&quot;orderID&quot;</span><span class="p">:</span><span class="ss">&quot;order04&quot;</span><span class="err">}</span><span class="p">,</span><span class="ss">&quot;timestamp&quot;</span><span class="p">:</span><span class="mi">1556252842194</span><span class="p">,</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;ContainerAllocated&quot;</span><span class="err">}</span>
</pre></div>

<h4 id="console-1-app">Console 1: app</h4>
<div class="codehilite"><pre><span></span><span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">21</span><span class="p">.</span><span class="mi">765</span>  <span class="n">INFO</span> <span class="mi">21610</span> <span class="c1">--- [ingConsumer-C-1] c.l.kc.containermgr.kafka.OrderConsumer  : Received order event:{&quot;orderID&quot;: &quot;order04&quot;, &quot;timestamp&quot;: 1556252841, &quot;type&quot;: &quot;OrderCreated&quot;, &quot;payload&quot;: {&quot;orderID&quot;: &quot;order04&quot;, &quot;productID&quot;: &quot;FreshFoodItg&quot;, &quot;customerID&quot;: &quot;Customer007&quot;, &quot;quantity&quot;: 180, &quot;pickupAddress&quot;: {&quot;street&quot;: &quot;astreet&quot;, &quot;city&quot;: &quot;Oakland&quot;, &quot;country&quot;: &quot;USA&quot;, &quot;state&quot;: &quot;CA&quot;, &quot;zipcode&quot;: &quot;95000&quot;}, &quot;destinationAddress&quot;: {&quot;street&quot;: &quot;bstreet&quot;, &quot;city&quot;: &quot;Beijing&quot;, &quot;country&quot;: &quot;China&quot;, &quot;state&quot;: &quot;NE&quot;, &quot;zipcode&quot;: &quot;09000&quot;}, &quot;pickupDate&quot;: &quot;2019-05-25&quot;, &quot;expectedDeliveryDate&quot;: &quot;2019-06-25&quot;}}</span>



<span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">22</span><span class="p">.</span><span class="mi">199</span>  <span class="n">INFO</span> <span class="mi">21610</span> <span class="c1">--- [ingConsumer-C-1] c.l.k.c.kafka.OrderProducerImpl          : Emit order event:{&quot;orderID&quot;:&quot;order04&quot;,&quot;payload&quot;:{&quot;containerID&quot;:&quot;itg-c03&quot;,&quot;orderID&quot;:&quot;order04&quot;},&quot;timestamp&quot;:1556252842194,&quot;type&quot;:&quot;ContainerAllocated&quot;}</span>

<span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">22</span><span class="p">.</span><span class="mi">273</span>  <span class="n">INFO</span> <span class="mi">21610</span> <span class="c1">--- [ingConsumer-C-1] c.l.k.c.kafka.ContainerProducerImpl      : Emit container event:{&quot;containerID&quot;:&quot;itg-c03&quot;,&quot;payload&quot;:{&quot;containerID&quot;:&quot;itg-c03&quot;,&quot;orderID&quot;:&quot;order04&quot;},&quot;timestamp&quot;:1556252842272,&quot;type&quot;:&quot;ContainerAssignedToOrder&quot;}</span>
</pre></div>

<h4 id="console-3-containers-consumer">Console 3: Containers consumer</h4>
<div class="codehilite"><pre><span></span><span class="o">@@@</span> <span class="n">pollNextOrder</span> <span class="n">containers</span> <span class="n">partition</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">at</span> <span class="k">offset</span> <span class="mi">6</span> <span class="k">with</span> <span class="k">key</span> <span class="n">b</span><span class="s1">&#39;itg-c03&#39;</span><span class="p">:</span>
    <span class="n">value</span><span class="p">:</span> <span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span><span class="ss">&quot;itg-c03&quot;</span><span class="p">,</span><span class="ss">&quot;payload&quot;</span><span class="p">:</span><span class="err">{</span><span class="ss">&quot;containerID&quot;</span><span class="p">:</span><span class="ss">&quot;itg-c03&quot;</span><span class="p">,</span><span class="ss">&quot;orderID&quot;</span><span class="p">:</span><span class="ss">&quot;order04&quot;</span><span class="err">}</span><span class="p">,</span><span class="ss">&quot;timestamp&quot;</span><span class="p">:</span><span class="mi">1556252842272</span><span class="p">,</span><span class="ss">&quot;type&quot;</span><span class="p">:</span><span class="ss">&quot;ContainerAssignedToOrder&quot;</span><span class="err">}</span>
</pre></div>

<h4 id="console-2">Console 2</h4>
<p>The postgresql containers table is also modified as capacity of the container is reduced by the order quantity and the status set to loaded (value 0):</p>
<div class="codehilite"><pre><span></span><span class="n">postgres</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">containers</span><span class="p">;</span>
   <span class="n">id</span>    <span class="o">|</span>   <span class="n">brand</span>   <span class="o">|</span> <span class="n">capacity</span> <span class="o">|</span>       <span class="n">created_at</span>        <span class="o">|</span> <span class="n">current_city</span> <span class="o">|</span> <span class="n">latitude</span> <span class="o">|</span> <span class="n">longitude</span> <span class="o">|</span> <span class="n">status</span> <span class="o">|</span>  <span class="k">type</span>  <span class="o">|</span>       <span class="n">updated_at</span>
<span class="c1">---------+-----------+----------+-------------------------+--------------+----------+-----------+--------+--------+-------------------------</span>
 <span class="n">itg</span><span class="o">-</span><span class="n">C02</span> <span class="o">|</span> <span class="n">itg</span><span class="o">-</span><span class="n">brand</span> <span class="o">|</span>        <span class="mi">0</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">26</span><span class="p">.</span><span class="mi">885</span> <span class="o">|</span> <span class="n">Oakland</span>      <span class="o">|</span>     <span class="mi">37</span><span class="p">.</span><span class="mi">8</span> <span class="o">|</span>   <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span> <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span> <span class="n">Reefer</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">21</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">57</span><span class="p">.</span><span class="mi">821</span>
 <span class="n">itg</span><span class="o">-</span><span class="n">c03</span> <span class="o">|</span> <span class="n">itg</span><span class="o">-</span><span class="n">brand</span> <span class="o">|</span>        <span class="mi">0</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">20</span><span class="p">:</span><span class="mi">51</span><span class="p">:</span><span class="mi">13</span><span class="p">.</span><span class="mi">424</span> <span class="o">|</span> <span class="n">Oakland</span>      <span class="o">|</span>     <span class="mi">37</span><span class="p">.</span><span class="mi">8</span> <span class="o">|</span>   <span class="o">-</span><span class="mi">122</span><span class="p">.</span><span class="mi">25</span> <span class="o">|</span>      <span class="mi">0</span> <span class="o">|</span> <span class="n">Reefer</span> <span class="o">|</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">25</span> <span class="mi">21</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">22</span><span class="p">.</span><span class="mi">159</span>
</pre></div>

<h2 id="listening-to-container-events">Listening to container events</h2>
<p>The use story is to get the container event from the kafka <code>containers</code> topics and add new Reefer container data to the inventory, or update existing container. So we need to add consumer and publisher using <a href="https://spring.io/projects/spring-kafka">Spring Kafka</a>. Spring Kafka template is based on the pure java kafka-clients jar but provides the same encapsulation as Spring JMS template. Here is the <a href="https://docs.spring.io/spring-kafka/docs/2.2.4.RELEASE/reference/">product documentation</a>.</p>
<p>First we need to start a kafka consumer when the application starts. We want one unique instance, so a singleton. As presented in <a href="https://www.baeldung.com/running-setup-logic-on-startup-in-spring">this article</a>, we select to add a Component that is an application listener (Annotation @EventListener) so when the spring context is running, we can start consuming messages from Kafka.</p>
<div class="codehilite"><pre><span></span><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ContainerConsumer</span> <span class="o">{</span>
    <span class="nd">@EventListener</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">ContextRefreshedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// prepare kafka consumer, add an event handler callback and start the consumer</span>
<span class="o">}</span>
</pre></div>

<p>The code is in the class: <code>ibm.labs.kc.containermgr.kafka.ContainerConsumer.java</code>. Spring Kafka container](https://docs.spring.io/spring-kafka/docs/2.2.4.RELEASE/reference/#receiving-messages) is not bringing that much value on top of Kafka Java API, and we prefer learning a unique API and keep programming with the Kafka Java API.</p>
<p>We have added an end to end integration test to create container events and see the payload persisted in Postgresql.  When running the server locally, you may want to leverage our <a href="https://github.com/ibm-cloud-architecture/refarch-kc/blob/master/docker/backbone-compose.yml">docker compose</a> file to start a local kafka broker.</p>
<h2 id="listening-to-order-event">Listening to Order Event</h2>
<p>The approach is the same as above and the supporting class is: <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/blob/master/SpringContainerMS/src/main/java/ibm/labs/kc/containermgr/kafka/OrderConsumer.java">ibm.labs.kc.containermgr.kafka.OrderConsumer</a>.</p>
<h2 id="security">Security</h2>
<p>To communicate with IBM Cloud PostgresSQl service the client needs to use SSL certificates...
First to avoid sharing userid and password in github, we use environment variables for postgressql url, user and password. There is a <code>setenv.tmpl.sh</code> in the <code>scripts</code> folder to use with your own settings. Rename it <code>setenv.sh</code>. This file is ignored by git. The values are coming from the IBM Cloud postgresql service. Also to run unit test in eclipse you need to set those environment variables in the run configuration as illustrated in the figure below:</p>
<p><img alt="" src="eclipse-envvar.png" /></p>
<p>Those variables are used the Spring boot <code>application.configuration</code> file, for example for the postgresql URL:</p>
<div class="codehilite"><pre><span></span>spring.datasource.url=<span class="cp">${</span><span class="n">POSTGRESQL_URL</span><span class="cp">}</span>
</pre></div>

<p>When the Spring repository class establishes a TLS or SSL communication to the Postgresql service in IBM Cloud (or ICP), both client and server negotiate a stateful connection by using a handshaking procedure. During this procedure, the server usually sends back its identification in the form of a digital certificate.</p>
<p>Java programs store certificates in a repository called Java KeyStore (JKS).</p>
<p>To create the SSL connection you will need to make the server public certificate available to your Java client JVM. The certificate is persisted in a Trustore. So get the server public certificate: <code>postgresql.crt</code>, then convert it to a form Java understands.
To download a text version of the base64 certificate as defined in the connection credentials of the IBM Cloud postgressql service use the following command:</p>
<p><div class="codehilite"><pre><span></span>$ ibmcloud cdb deployment-cacert Green-DB-PostgreSQL
<span class="c1"># if you do not have the cloud database plugin does the following and rerun previous command:</span>
$ ibmcloud plugin install cloud-databases
</pre></div>
Save the certificate to a file (e.g. postgressql.crt). Then transform it to a Java format and save it to a keystore used by Java</p>
<div class="codehilite"><pre><span></span><span class="c1"># transform</span>
$ openssl x509 -in postgressql.crt -out postgressql.crt.der -outform der
<span class="c1"># save in keystore</span>
$ keytool -keystore clienttruststore -alias postgresql -import -file postgressql.crt.der -storepass changeit
</pre></div>

<p>Then adding the following setting will let the Java program accesses the certificates from the keystore.</p>
<div class="codehilite"><pre><span></span><span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="o">-</span><span class="n">Djavax</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">ssl</span><span class="p">.</span><span class="n">trustStore</span><span class="o">=</span><span class="n">clienttruststore</span> <span class="o">-</span><span class="n">Djavax</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="n">ssl</span><span class="p">.</span><span class="n">trustStorePassword</span><span class="o">=</span><span class="n">changeit</span> <span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">SpringContainerMS</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="o">-</span><span class="n">SNAPSHOT</span><span class="p">.</span><span class="n">jar</span> <span class="n">application</span><span class="p">.</span><span class="n">SBApplication</span>
</pre></div>

<p>We recommend reading <a href="https://jdbc.postgresql.org/documentation/91/ssl-client.html">this section</a> of Postgresql product documentation, and <a href="https://www.baeldung.com/java-ssl-handshake-failures">this article from Baeldung</a> on SSL handshake in Java.</p>
<p>Now to make all this available in docker container we propose to let the previous two commands run within the Dockerfile during the build process.</p>
<h2 id="manually-deploy-to-iks">Manually deploy to IKS</h2>
<p>The steps are the same as other project and we are providing the same type of tools:</p>
<ul>
<li>
<p>login to IBM Cloud - Adapt to your region.
<div class="codehilite"><pre><span></span>ibmcloud login -a https://api.us-east.bluemix.net
</pre></div></p>
</li>
<li>
<p>connect to the IKS cluster
<div class="codehilite"><pre><span></span><span class="n">ibmcloud</span> <span class="n">ks</span> <span class="n">region</span><span class="o">-</span><span class="k">set</span> <span class="n">us</span><span class="o">-</span><span class="n">east</span>
<span class="n">ibmcloud</span> <span class="n">ks</span> <span class="k">cluster</span><span class="o">-</span><span class="n">config</span> <span class="n">fabio</span><span class="o">-</span><span class="n">wdc</span><span class="o">-</span><span class="mi">07</span>
</pre></div></p>
</li>
<li>
<p>Define the Kube config variable so all the kubectl and helm commands will contact the good cluster.
<div class="codehilite"><pre><span></span><span class="n">export</span> <span class="n">KUBECONFIG</span><span class="o">=</span> <span class="o">~/</span><span class="p">.</span><span class="n">bluemix</span><span class="o">/</span><span class="n">plugins</span><span class="o">/</span><span class="n">container</span><span class="o">-</span><span class="n">service</span><span class="o">/</span><span class="n">clusters</span><span class="o">/</span><span class="n">fabio</span><span class="o">-</span><span class="n">wdc</span><span class="o">-</span><span class="mi">07</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">wdc07</span><span class="o">-</span><span class="n">fabio</span><span class="o">-</span><span class="n">wdc</span><span class="o">-</span><span class="mi">07</span><span class="p">.</span><span class="n">yml</span>
</pre></div></p>
</li>
<li>
<p>login to the private registry
<div class="codehilite"><pre><span></span><span class="n">ibmcloud</span> <span class="n">cr</span> <span class="n">login</span>
</pre></div></p>
</li>
<li>
<p>build the application jar and docker image using our script
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">script</span><span class="o">/</span><span class="n">buildDocker</span><span class="p">.</span><span class="n">sh</span> <span class="n">IBMCLOUD</span>
</pre></div></p>
</li>
<li>
<p>Push the docker image to the private registry
<div class="codehilite"><pre><span></span><span class="n">docker</span> <span class="n">push</span>  <span class="n">us</span><span class="p">.</span><span class="n">icr</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">ibmcaseeda</span><span class="o">/</span><span class="n">kcontainer</span><span class="o">-</span><span class="n">spring</span><span class="o">-</span><span class="n">container</span><span class="o">-</span><span class="n">ms</span>
</pre></div></p>
</li>
<li>
<p>Deploy the Helm release
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">deployHelm</span>
</pre></div></p>
</li>
</ul>
<p>which is equivalent to the command:</p>
<div class="codehilite"><pre><span></span> <span class="n">helm</span> <span class="n">install</span> <span class="err">$</span><span class="n">chart</span><span class="o">/</span> <span class="c1">--name $kname --namespace $ns</span>
</pre></div>

<p>If for any reason you get a "image can't be pulled" error. Verify the image is in the private registry with the command:</p>
<div class="codehilite"><pre><span></span><span class="n">docker</span> <span class="n">cr</span> <span class="n">image</span><span class="o">-</span><span class="n">list</span>
</pre></div>

<p>Then if the image exists, verify there is a secret defined to keep the security key to access the registry in the same namespace as you are deploying your app, and this secret is referenced in the yaml file:</p>
<div class="codehilite"><pre><span></span><span class="ss">&quot;imagePullSecrets&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="err">{</span>
            <span class="ss">&quot;name&quot;</span><span class="p">:</span> <span class="ss">&quot;browncompute-registry-secret&quot;</span>
          <span class="err">}</span>
        <span class="p">],</span>
</pre></div>

<h3 id="perform-integration-tests-from-local-to-remote-ibm-cloud-deployment">Perform integration tests from local to remote IBM Cloud deployment</h3>
<p>As presented in the <a href="#the-integration-tests">section above</a>, we have a set of tools that can create container, orders and verify the code is running well in its complete deployed environment. The same scripts can be run with the IBMCLOUD argument.</p>
<p>So below is the list of command to perform on you laptop while the Spring boot app is deployed on IKS, using Event Streams and Postgresql on IBM Cloud:</p>
<ul>
<li>Start a container consumer to trace the execution: in the folder <code>refarch-kc/itg-tests/ContainersPython</code>. It listens to get a container with id: "ic-c01"</li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">runContainerConsumer</span><span class="p">.</span><span class="n">sh</span> <span class="n">IBMCLOUD</span> <span class="n">ic</span><span class="o">-</span><span class="n">c01</span>
</pre></div>

<ul>
<li>Run a producer of container events to add a new container into the inventory: in the same folder <code>refarch-kc/itg-tests/ContainersPython</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">addContainer</span><span class="p">.</span><span class="n">sh</span> <span class="n">IBMCLOUD</span> <span class="n">ic</span><span class="o">-</span><span class="n">c01</span>
</pre></div>

<ul>
<li>Start an order consumer, to trace the traffic: in the folder <code>refarch-kc/itg-tests/OrdersPython</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">runOrderConsumer</span><span class="p">.</span><span class="n">sh</span> <span class="n">IBMCLOUD</span> <span class="n">order01</span>
</pre></div>

<ul>
<li>Create an order from the same folder:  <code>refarch-kc/itg-tests/OrdersPython</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">addOrder</span><span class="p">.</span><span class="n">sh</span> <span class="n">IBMCLOUD</span> <span class="n">order01</span>
</pre></div>

<p>Going to the web URL of the container service you should see the container added.</p>
<h2 id="encountered-issues-with-some-solution">Encountered issues with some solution</h2>
<p>The level of abstraction in Spring is nice when doing basic things but can become a nightmare when doing real bigger application including different libraries. Also migrating or using the last version 2.xx, bring changes to existing code and tests. Below is a list of iisues we spent time on:</p>
<ul>
<li>When JPA started, it creates / updates database schema, and for example enforced to have an Id as int while it was as string. As a bypass we create the table before in postsgresql using psql tool.</li>
<li>When starting the spring data, JPA will try to connect to the PostgresSQL and execute a set of validation, one of them could generate the following exception: <code>Method org.postgresql.jdbc.PgConnection.createClob() is not yet implemented</code>. The explanation for the solution is <a href="https://vkuzel.com/spring-boot-jpa-hibernate-atomikos-postgresql-exception">here.</a></li>
<li>When running the SpringContainer inside docker-compose the following exception may occur <code>org.postgresql.util.PSQLException: Connection to postgres:5432 refused. Check that the hostname and port are correct and that the postmaster is accepting TCP/IP connections</code> while running the same code with maven using the same local backend works.</li>
<li>
<p>Testing endpoint /health did not work on Spring 2.1.4. This is due a new Actuator capabilities (<code>spring-boot-starter-actuator</code>) that adds endpoints to manage a webapp in production. This is a nice feature. So remove any hold Health api class and modify the url to <code>/actuator/health</code>. Be sure to read <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-endpoints.html">this note</a> on actuator.</p>
</li>
<li>
<p>Deployed in Kubernetes service, the pod has issue on postgress SSL handshake. (org.postgresql.util.PSQLException: SSL error: Received fatal alert: handshake_failure). SSL handshakes are a mechanism by which a client and server establish the trust and logistics required to secure their connection over the network. This problem may be linked to a SSL certificate not found or wrong encryption protocol. We need to be sure a Java Keystore is defined and includes the public certificate coming from the server. See <a href="#security">security section</a> above.</p>
</li>
<li>
<p>When deploying to IKS, we did see an exception about <code>container topics not visible</code>. This problem is coming from the fact that we are using Event Stream simplest deployment, which is multi tenants. And even if our code reach the brokers, our api key was wrong so we could get to another instance which did not have our topics. Be sure the api key is well defined in the kubernetes secret. (see <a href="https://ibm-cloud-architecture.github.io/refarch-kc/deployments/iks/#event-stream-api-key">this note to know how to do it</a>)</p>
</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://start.spring.io/">Spring Code generator</a></li>
<li><a href="https://spring.io/projects/spring-kafka">Spring Kafka</a> and the spring kafka <a href="https://docs.spring.io/spring-kafka/docs/2.2.4.RELEASE/reference">documentation</a></li>
<li><a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/">sptring Data and JPA</a></li>
<li><a href="">SSL and postgresql</a></li>
<li><a href="http://tleyden.github.io/blog/2017/06/14/running-postgresql-in-docker/">Runninf postgresql in docker</a></li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deployment/" title="Pre-requisites" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Pre-requisites
              </span>
            </div>
          </a>
        
        
          <a href="../cicd/" title="Continuous delivery" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Continuous delivery
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>